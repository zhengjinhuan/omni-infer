# Omni Proxy 批处理调度简化方案

为便于评估批处理调度的收益，同时遵循“记录—预判—排队—择优”六步逻辑，Omni Proxy 中的 prefill 调度被改写为如下简化模型：

1. **记录执行中的请求**：每个 upstream 保存一份活动请求列表与计数器，调度或唤醒阶段都会更新，便于后续判断哪些请求仍处于处理流程。
2. **批阶段预判**：只要任意一个活动请求返回响应，即认为该 upstream 上所有活动请求均进入同一批次的执行阶段，并据此刷新批次结束时间。
3. **新请求视为排队**：在调度环节中，所有新加入的请求都会先落入后端排队队列，直到对应批次真正被唤醒执行。
4. **最早完成优先**：为每个候选 upstream 计算“最早完成时间”，始终选择结束时间最小的节点；若容量受限再退化为按 token 负载挑选。
5. **前后批次皆纳入估计**：最早完成时间由当前批次的预测结束时间与排队批次的预计结束时间共同决定，确保不会忽略仍在执行或等待中的请求。
6. **历史驱动的批次时长**：利用最近批次的请求数量和响应耗时统计，推导出单请求平均耗时，新请求的批次结束时间在此基础上递推得到。

上述改动只影响 prefill 阶段；decode 调度依旧按到达顺序并基于 token 负载进行轻量化的均衡分配，以避免在频繁的 decode 轮次中额外引入预测成本。
